function Initialise(){var e=new Date,t=e.getDate(),a=e.getMonth()+1,n=e.getFullYear();origLat=accLat,origLon=accLon,10>t&&(t="0"+t),10>a&&(a="0"+a),curDate=n+"-"+a+"-"+t,"GPS"==usage&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};accLat=t.lat,accLon=t.lng}),j$(document).ready(function(){CreateMap(),buildCampagnesListe(),getData(),j$("#Listecmp").change(function(){getData(),rcSetcsCurrentCampaign()}),j$("#Marquers").change(function(){getData()}),j$("#Distance").change(function(){getData()}),j$("#startdate").change(function(){curDate=document.getElementById("startdate").value}),j$("#srtComp").click(function(){BuildTable(!0,"comp")}),j$("#srtDist").click(function(){BuildTable(!0,"dist")}),j$("#swLea").change(function(){swLea=!swLea,BuildTable(!0)}),j$("#swAcc").change(function(){swAcc=!swAcc,BuildTable(!0)});var e=document.getElementById("Listecmp-button"),t=document.getElementById("Listecmp").selectedIndex;e.children[0].innerHTML=document.getElementById("Listecmp").children[t].innerHTML})}function rcSetcsCurrentCampaign(){var e=document.getElementById("Listecmp").value;Visualforce.remoting.Manager.invokeAction(callupdateCC,e,function(e,t){t.status||"exception"===t.type},{escape:!1})}function getData(){accLat=origLat,accLon=origLon,campagne=document.getElementById("Listecmp").value,Visualforce.remoting.Manager.invokeAction(callGetData,campagne,function(e,t){t.status?(maListe=JSON.parse(e),BuildTable(!1)):"exception"===t.type},{escape:!1})}function CreateMap(){var e={lat:accLat,lng:accLon},t={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,overviewMapControl:!0,rotateControl:!0,scrollwheel:!0,draggable:!0,panControl:!0,zoomControl:!0,scaleControl:!0,center:e,streetViewControl:!0};map=new google.maps.Map(document.getElementById("map"),t);var a=mypath+"/32/fatcow/farmfresh/flag_blue.png";marker_home=new google.maps.Marker({map:map,icon:a,fillOpacity:1,position:{lat:accLat,lng:accLon},label:"You are here !",scale:8}),markerBounds=new google.maps.LatLngBounds}function isValidDate(e,t){function a(e,t){var a,n,i,r,s=0,l=t.length;for(s;l>s;s++)r=t[s],/m/.test(r)&&(a=e[s]),/d/.test(r)&&(n=e[s]),/y/.test(r)&&(i=e[s]);return a>0&&13>a&&i&&4===i.length&&n>0&&n<=new Date(i,a,0).getDate()}t=t||"dd/mm/yyyy";var n=/[^mdy]/.exec(t)[0],i=t.split(n),r=e.split(n);return a(r,i)}function escapeSpecialChars(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f")}function buildCampagnesListe(){sele=document.getElementById("Listecmp");var e="<select>",t=0;for(cmp in mescampag)null!=mescampag[cmp].Name&&mescampag[cmp].NumberOfContacts+mescampag[cmp].NumberOfLeads>0&&(e+='<option value="'+mescampag[cmp].Id+(curcamp==mescampag[cmp].Id?'" selected>':'">')+mescampag[cmp].Name+" (L) "+mescampag[cmp].NumberOfLeads+" (C) "+mescampag[cmp].NumberOfContacts+"</option>",t++);e+="</select>",sele.innerHTML=e}function BuildTable(e,t,a){if(jQuery("#InfoBody").children().remove(),!e){lstTri=[];for(var n=0;n<maListe.length;n++)null!=maListe[n].Lat&&(maListe[n].distance=distance(maListe[n].Lat,maListe[n].Lon,accLat,accLon),lstTri[lstTri.length]=maListe[n])}for(var i=document.getElementById("InfoBody"),r=0,l=0;l<mesMarqueurs.length;l++)mesMarqueurs[l].setMap(null);var o=!0;mesMarqueurs=[],markerBounds=new google.maps.LatLngBounds;var c={acc:0,opp:0,rdv:0,lea:0};if(null!=t)switch(t){case"dist":lstTri.sort(compare_d);break;case"comp":lstTri.sort(compare_c);break;case"type":lstTri.sort(compare_t)}else lstTri.sort(compare_d);if(lstTri.length>0)for(var n=0;n<lstTri.length;n++){if(null!=lstTri[n].Company){console.log(lstTri[n]),contentString="";var m="<a href=/"+lstTri[n].Id+' target="_blank">'+lstTri[n].Name+"</a><br/>";m=m+lstTri[n].Address+"à "+lstTri[n].distance.toFixed(2)+" km <br> Dernière Activité:"+(null!=lstTri[n].LAD?lstTri[n].LAD:"Inconnu"),m+="<br> <b> Sec. Act.: </b> "+(null!=lstTri[n].SA?lstTri[n].SA:"Inconnu"),"acc"==lstTri[n].Type&&(m+="<br> <b> CA 2016: </b> "+(null!=lstTri[n].CA_2016?lstTri[n].CA_2016:"Pas de données"),m+="<br> <b> CA 2015: </b> "+(null!=lstTri[n].CA_2016?lstTri[n].CA_2016:"Pas de données")),contentString=m}else contentString="<b>Hello</b><br>";var d=i.insertRow(n);d.id="table_row_"+n,d.hidden=!(swAcc&&"acc"==lstTri[n].Type||swLea&&"lea"==lstTri[n].Type);var u=d.insertCell(),p=d.insertCell(),g=d.insertCell(),T=d.insertCell(),f=d.insertCell(),h=d.insertCell(),L=d.insertCell(),v=d.insertCell(),b=d.insertCell(),C=d.insertCell();C.innerHTML='<button type="button" class="btn btn-default btn-xs">Focus</button>',C.id="cellCenter_"+n,b.innerHTML="<textarea>"+lstTri[n].Newtask.Description+"</textarea>",b.id="cellLogCall_"+n,u.innerHTML="<a href=/"+lstTri[n].accId+' target="_blank">'+lstTri[n].Company+"</a>",u.id="cellCompany_"+n,L.id="cellRemarques_"+n,null!=lstTri[n].Remarques?L.innerHTML="<textarea>"+lstTri[n].Remarques+"</textarea>":L.innerHTML="<textarea></textarea>",v.id="cellStatus_"+n,strSelect="<select>";for(s in status_v)null!=status_v[s].value&&(strSelect+='<option value = "'+status_v[s].value+'"'+(lstTri[n].Statut==status_v[s].value?" selected> ":">")+status_v[s].label+"</option>");strSelect+="</select>",v.innerHTML=strSelect;var m="<a href=/"+lstTri[n].Id+' target="_blank">'+lstTri[n].Name+" ("+lstTri[n].LorC+")</a><br/>";p.innerHTML=m,v.id="cellName_"+n,null!=lstTri[n].Phone&&(g.innerHTML='<a href="tel:+'+lstTri[n].Phone+'" target="_blank">'+lstTri[n].Phone+"</a>"),now=new Date,null!=lstTri[n].LAD?(last=Date.parse(lstTri[n].LAD),delai=(now.getTime()-last)/864e5):delai=101,delai<=7?f.innerHTML='<img src ="'+custXPImages+'/images/NO_Red.png" height="24" width="24">':delai<=21?f.innerHTML='<img src ="'+custXPImages+'/images/Warning_Yellow.png" height="24" width="24">':f.innerHTML='<img src ="'+custXPImages+'/images/OK_Green.png" height="24" width="24">',null!=lstTri[n].Email&&(T.innerHTML='<a href="mailto:'+lstTri[n].Email+'?subject=Feedback target="_blank"><img src="'+mypath+'/32/fatcow/farmfresh/email.png" alt="Smiley face" height="32" width="32"></a>'),h.innerHTML=lstTri[n].City+"<i> (à"+lstTri[n].distance.toFixed(2)+" km)</i>",h.id="Celldist_"+n;var y=new google.maps.Marker({map:d.hidden?null:map,animation:google.maps.Animation.DROP,fillOpacity:1,position:{lat:parseFloat(lstTri[n].Lat),lng:parseFloat(lstTri[n].Lon)},label:lstTri[n].company,scale:8});markerBounds.extend(y.position),map.fitBounds(markerBounds);switch(mkcolor=mypath+"/32/fatcow/farmfresh/group.png",lstTri[n].type){case"acc":mkcolor=mypath+"/32/fatcow/farmfresh/user_suit.png",c.acc++;break;case"rdv":mkcolor=mypath+"/32/fatcow/farmfresh/group.png",c.rdv++,o&&lstTri[n].ActivityDate.substr(0,10)==curDate.toString().substr(0,10)&&(map.setCenter(y.position),markerBounds.extend(y.position),map.fitBounds(markerBounds),o=!1);break;case"lea":mkcolor=mypath+"/32/fatcow/farmfresh/vcard.png",c.lea++;break;case"opp":mkcolor=mypath+"/32/fatcow/farmfresh/coins.png",c.opp++}y.setIcon(mkcolor),attachDescr(y,contentString),lstTri[n].marker=y,mesMarqueurs[r]=y;var w=new google.maps.InfoWindow({content:contentString,map:map,position:{lat:parseFloat(lstTri[n].Lat),lng:parseFloat(lstTri[n].Lon)}});lstTri[n].InfoWindow=w,lstTri[n].InfoWindow.close(),r++}j$('td[id*="Celldist"]').bind("mouseenter",function(){var e=j$(this).context.id.split("_")[1];lstTri[e].marker.setAnimation(google.maps.Animation.BOUNCE),lstTri[e].InfoWindow.open(map,lstTri[e].marker)}),j$('td[id*="Celldist"]').bind("mouseleave",function(){var e=j$(this).context.id.split("_")[1];lstTri[e].marker.setAnimation(null),lstTri[e].InfoWindow.close()}),j$('td[id*="cellCompany"]').bind("mouseenter",function(){var e=j$(this).context.id.split("_")[1];lstTri[e].marker.setAnimation(google.maps.Animation.BOUNCE),lstTri[e].InfoWindow.open(map,lstTri[e].marker)}),j$('td[id*="cellCompany"]').bind("mouseleave",function(){var e=j$(this).context.id.split("_")[1];lstTri[e].marker.setAnimation(null),lstTri[e].InfoWindow.close()}),j$('td[id*="cellName"]').bind("mouseenter",function(){var e=j$(this).context.id.split("_")[1];lstTri[e].marker.setAnimation(google.maps.Animation.BOUNCE),lstTri[e].InfoWindow.open(map,lstTri[e].marker)}),j$('td[id*="cellName"]').bind("mouseleave",function(){var e=j$(this).context.id.split("_")[1];lstTri[e].marker.setAnimation(null),lstTri[e].InfoWindow.close()}),j$('td[id*="cellRemarques"]').bind("focusout",function(){var e=j$(this).context.id.split("_")[1],t=lstTri[e].Id,a="mes_remarques__c",n=j$(this).context.children[0].value;callMaj(t,a,n)}),j$('td[id*="cellStatus"]').bind("focusout",function(){var e=j$(this).context.id.split("_")[1],t=lstTri[e].Id,a="status",n=j$(this).context.children[0].selectedIndex,i=j$(this).context.children[0].options[n].innerHTML.trim();callMaj(t,a,i)}),j$('td[id*="cellLogCall"]').bind("focusout",function(){var e=j$(this).context.id.split("_")[1],t=lstTri[e].idLoC,a=document.getElementById("Listecmp").value;"L"==lstTri[e].LorC&&(a="");var n=j$(this).context.children[0].value;callMajTask(t,a,n)}),j$('td[id*="cellCenter"]').bind("click",function(){console.log("hello");var e=j$(this).context.id.split("_")[1];lstTri[e].idLoC;accLat=parseFloat(lstTri[e].Lat),accLon=parseFloat(lstTri[e].Lon);for(var t={lat:parseFloat(lstTri[e].Lat),lng:parseFloat(lstTri[e].Lon)},a=0;a<lstTri.length;a++)lstTri[a].distance=distance(t.lat,t.lng,lstTri[a].Lat,lstTri[a].Lon);BuildTable(!0,"dist"),map.setCenter(t)})}function attachDescr(e,t){var a=new google.maps.InfoWindow({content:t});e.addListener("click",function(){}),e.addListener("mouseover",function(){a.open(map,e)}),e.addListener("mouseout",function(){a.close()})}function deg2rad(e){return e*Math.PI/180}function compare_d(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}function compare_c(e,t){return e.Company<t.Company?-1:e.Company>t.Company?1:0}function compare_t(e,t){return e.Type<t.Type?-1:e.Type>t.Type?1:0}function distance(e,t,a,n){var i=6371,r=deg2rad(a-e),s=deg2rad(n-t),l=Math.sin(r/2)*Math.sin(r/2)+Math.cos(deg2rad(e))*Math.cos(deg2rad(a))*Math.sin(s/2)*Math.sin(s/2),o=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),c=i*o;return c}function callMaj(e,t,a){Visualforce.remoting.Manager.invokeAction(callupdateCM,e,t,a,function(e,t){t.status||"exception"===t.type&&(console(t.message),console(t.where))},{escape:!1})}function callMajTask(e,t,a){Visualforce.remoting.Manager.invokeAction(callinsertTask,e,t,a,function(e,t){t.status||"exception"===t.type&&(console(t.message),console(t.where))},{escape:!1})}var Name,usage,ObjID,curDate,Marqueurs=10,Distance=10,accLat,accLon,swOpp=!1,swAcc=!0,swLea=!0,swRdV=!0,color="#0000FF",mesMarqueurs=[],mesInfoWindows=[],geocoder,map,markerBounds;